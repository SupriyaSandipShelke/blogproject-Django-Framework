{% extends 'blog/base.html' %}

{% block content %}
<style>
    .post-img {
        max-height: 400px;
        object-fit: cover;
        border-radius: 8px;
    }
    
    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .post-meta {
        color: #666;
        font-size: 0.95em;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        margin: 25px 0;
        flex-wrap: wrap;
    }
    
    .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.95em;
        font-weight: 500;
    }
    
    .action-btn:hover {
        border-color: #5c7cbc;
        color: #5c7cbc;
    }
    
    .action-btn.liked {
        background: #5c7cbc;
        color: white;
        border-color: #5c7cbc;
    }
    
    .action-btn a {
        color: inherit;
        text-decoration: none;
    }
    
    .like-count {
        background: #f5f5f5;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        color: #666;
        margin-top: 10px;
    }
    
    .comments-section {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #e0e0e0;
    }
    
    .comment-box {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .comment-author {
        font-weight: 600;
        color: #333;
    }
    
    .comment-date {
        font-size: 0.85em;
        color: #999;
    }
    
    .comment-text {
        color: #555;
        line-height: 1.6;
    }
    
    .comment-form {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .comment-form textarea {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        font-family: inherit;
    }
    
    .emoji-picker-btn {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        padding: 5px;
        transition: transform 0.2s;
    }
    
    .emoji-picker-btn:hover {
        transform: scale(1.2);
    }
    
    .emoji-picker-container {
        display: none;
        position: absolute;
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 300px;
    }
    
    .emoji-picker-container.show {
        display: grid;
    }
    
    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
    }
    
    .emoji-item {
        font-size: 1.5em;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        text-align: center;
        transition: all 0.2s;
    }
    
    .emoji-item:hover {
        background: #f0f0f0;
        transform: scale(1.2);
    }
    
    .emoji-categories {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    .emoji-category-btn {
        background: none;
        border: 1px solid #ddd;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.2em;
        transition: all 0.2s;
    }
    
    .emoji-category-btn.active {
        background: #5c7cbc;
        color: white;
        border-color: #5c7cbc;
    }
    
    .comment-form-wrapper {
        position: relative;
    }
    
    .textarea-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        margin-bottom: 10px;
    }
    
    .section-title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        border-left: 4px solid #5c7cbc;
        padding-left: 12px;
    }
    
    .share-menu {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .share-btn {
        padding: 8px 15px;
        font-size: 0.9em;
        border-radius: 6px;
        text-decoration: none;
        color: white;
    }
    
    .share-facebook {
        background: #1877f2;
    }
    
    .share-twitter {
        background: #1da1f2;
    }
    
    .share-whatsapp {
        background: #25d366;
    }
    
    .share-email {
        background: #ea4335;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }
</style>

<div class="container mt-4">
    <div class="card shadow">
        {% if post.image %}
            <img src="{{ post.image.url }}" class="card-img-top post-img">
        {% else %}
            <div class="card-img-top post-img" style="background-color: #e9ecef; display: flex; align-items: center; justify-content: center; min-height: 300px;">
                <span class="text-muted">No Image</span>
            </div>
        {% endif %}

        <div class="card-body">
            <div class="post-header">
                <div>
                    <h1 style="margin: 0; margin-bottom: 10px;">{{ post.title }}</h1>
                    <p class="post-meta">
                        By <strong>{{ post.author.username }}</strong> | {{ post.created_at|date:"d M Y" }} 
                        {% if post.category %}
                            | <span class="badge bg-primary">{{ post.category.name }}</span>
                        {% endif %}
                    </p>
                </div>
                
                {% if user == post.author %}
                <div>
                    <a href="{% url 'edit_post' post.id %}" class="btn btn-warning btn-sm">‚úèÔ∏è Edit</a>
                    <a href="{% url 'delete_post' post.id %}" class="btn btn-danger btn-sm">üóëÔ∏è Delete</a>
                </div>
                {% endif %}
            </div>

            <div style="line-height: 1.8; font-size: 1.05em; color: #333; margin: 25px 0;">
                {{ post.content }}
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                {% if user.is_authenticated %}
                    <form method="post" action="{% url 'like_post' post.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="action-btn {% if user_has_liked %}liked{% endif %}">
                            ‚ù§Ô∏è {% if user_has_liked %}Unlike{% else %}Like{% endif %}
                        </button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="action-btn" style="text-decoration: none;">
                        ‚ù§Ô∏è Like
                    </a>
                {% endif %}
                
                <button class="action-btn" onclick="toggleShareMenu()">
                    üì§ Share
                </button>
                
                <button class="action-btn" onclick="scrollToComments()">
                    üí¨ Comment
                </button>
            </div>

            <!-- Like Count -->
            {% if total_likes > 0 %}
            <div class="like-count">
                ‚ù§Ô∏è {{ total_likes }} {% if total_likes == 1 %}person likes{% else %}people like{% endif %} this post
            </div>
            {% endif %}

            <!-- Share Menu -->
            <div id="shareMenu" style="display: none;" class="share-menu" style="margin-top: 15px;">
                <a href="https://www.facebook.com/sharer/sharer.php?u=http://127.0.0.1:8000/post/{{ post.id }}/" target="_blank" class="share-btn share-facebook">
                    üìò Facebook
                </a>
                <a href="https://twitter.com/intent/tweet?url=http://127.0.0.1:8000/post/{{ post.id }}/&text={{ post.title }}" target="_blank" class="share-btn share-twitter">
                    ùïè Twitter
                </a>
                <a href="https://wa.me/?text=Check%20this%20blog:%20{{ post.title }}%20http://127.0.0.1:8000/post/{{ post.id }}/" target="_blank" class="share-btn share-whatsapp">
                    üí¨ WhatsApp
                </a>
                <a href="mailto:?subject={{ post.title }}&body=Check%20this%20blog:%20http://127.0.0.1:8000/post/{{ post.id }}/" class="share-btn share-email">
                    ‚úâÔ∏è Email
                </a>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
        <h3 class="section-title">üí¨ Comments ({{ comments.count }})</h3>

        {% if comments %}
            <div style="margin-bottom: 30px;">
                {% for comment in comments %}
                    <div class="comment-box">
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.user.username }}</span>
                            <span class="comment-date">{{ comment.created_at|date:"d M Y, g:i A" }}</span>
                        </div>
                        <p class="comment-text">{{ comment.text }}</p>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <p>No comments yet. Be the first to comment!</p>
            </div>
        {% endif %}

        <!-- Comment Form -->
        {% if user.is_authenticated %}
        <div class="comment-form">
            <h5 style="margin-bottom: 15px;">Add Your Comment</h5>
            <div class="comment-form-wrapper">
                <form method="POST" style="width: 100%;">
                    {% csrf_token %}
                    <div class="textarea-wrapper">
                        <textarea id="commentText" name="text" class="form-control" placeholder="Share your thoughts..." rows="4" required style="flex: 1;"></textarea>
                        <button type="button" class="emoji-picker-btn" id="emojiBtn" title="Add Emoji">üòä</button>
                    </div>
                    
                    <!-- Emoji Picker -->
                    <div id="emojiPicker" class="emoji-picker-container">
                        <div class="emoji-categories">
                            <button type="button" class="emoji-category-btn active" data-category="smileys">üòä</button>
                            <button type="button" class="emoji-category-btn" data-category="hand">üëã</button>
                            <button type="button" class="emoji-category-btn" data-category="animals">üê±</button>
                            <button type="button" class="emoji-category-btn" data-category="food">üçï</button>
                            <button type="button" class="emoji-category-btn" data-category="activity">‚öΩ</button>
                            <button type="button" class="emoji-category-btn" data-category="travel">üåç</button>
                            <button type="button" class="emoji-category-btn" data-category="objects">üí°</button>
                            <button type="button" class="emoji-category-btn" data-category="symbols">‚ù§Ô∏è</button>
                        </div>
                        <div class="emoji-grid" id="emojiGrid"></div>
                    </div>
                    
                    <button class="btn btn-primary mt-3" type="submit">Post Comment</button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info" role="alert">
            <strong>Want to comment?</strong> <a href="{% url 'login' %}">Login</a> or <a href="{% url 'signup' %}">Sign up</a> to join the discussion.
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Emoji data organized by category
    const emojiData = {
        smileys: ['üòä', 'üòÇ', 'ü§£', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§ó', 'üòç', 'üòò', 'ü•∞', 'üòá', 'ü•≥', 'üòé', 'ü§î', 'üòè', 'üòå', 'üòî', 'üò¢', 'üò≠', 'üò±', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•'],
        hand: ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü´∞', 'ü§ü', 'ü§ò', 'ü§ô', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù'],
        animals: ['üê±', 'üê∂', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù'],
        food: ['üçï', 'üçî', 'üçü', 'üå≠', 'üçø', 'ü•ì', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üåÆ', 'üåØ', 'ü•ô', 'üßÜ', 'üçó', 'üçñ', 'üå∂Ô∏è', 'üç≤', 'ü•ò', 'üçõ', 'üçú', 'üçù', 'üç†', 'üç±', 'üç£', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•'],
        activity: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé≥', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ä', 'ü•ã', 'üéΩ', 'üéø', '‚õ∑Ô∏è', 'üõÇ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üé£', 'üéΩ', 'üéÆ', 'üéØ', 'üé≤', 'üé∞'],
        travel: ['üåç', 'üåé', 'üåè', 'üó∫Ô∏è', 'üóø', 'üóΩ', 'üóº', 'üèîÔ∏è', '‚õ∞Ô∏è', 'üåã', '‚õ©Ô∏è', 'üè∞', 'üèØ', 'üèüÔ∏è', 'üíà', '‚õ≤', '‚õ∫', 'üèïÔ∏è', '‚õ∂', 'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üõª'],
        objects: ['üí°', 'üî¶', 'üèÆ', 'üìî', 'üìï', 'üìñ', 'üìó', 'üìò', 'üìô', 'üìö', 'üìì', 'üìí', 'üìë', 'üß∑', 'üßπ', 'üß∫', 'üßª', 'üßº', 'üßΩ', 'üßØ', 'üõí', 'üöö', 'üöõ', 'üöú', 'üíé', '‚ö±Ô∏è', '‚ö∞Ô∏è', 'ü™¶', '‚öóÔ∏è', 'üî≠', 'üî¨'],
        symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', 'üíå', 'üíã', 'üíØ', 'üí¢', 'üí•', 'üí´', 'üí¶', 'üí®', 'üï≥Ô∏è', 'üí¨', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üó®Ô∏è']
    };

    let currentCategory = 'smileys';

    // Initialize emoji picker
    function initEmojiPicker() {
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');
        const categoryBtns = document.querySelectorAll('.emoji-category-btn');
        
        // Toggle emoji picker
        emojiBtn.addEventListener('click', function(e) {
            e.preventDefault();
            emojiPicker.classList.toggle('show');
        });

        // Category buttons
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                categoryBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                displayEmojis(currentCategory);
            });
        });

        // Display emojis
        function displayEmojis(category) {
            emojiGrid.innerHTML = '';
            emojiData[category].forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji-item';
                span.textContent = emoji;
                span.addEventListener('click', function(e) {
                    e.preventDefault();
                    insertEmoji(emoji);
                });
                emojiGrid.appendChild(span);
            });
        }

        // Insert emoji into textarea
        function insertEmoji(emoji) {
            const textarea = document.getElementById('commentText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
        }

        // Initial display
        displayEmojis(currentCategory);

        // Close picker when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.comment-form-wrapper')) {
                emojiPicker.classList.remove('show');
            }
        });
    }

    // Function to toggle share menu
    function toggleShareMenu() {
        const menu = document.getElementById('shareMenu');
        menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
    }
    
    function scrollToComments() {
        document.querySelector('.comments-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize emoji picker when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initEmojiPicker();
    });
</script>

{% endblock %}
